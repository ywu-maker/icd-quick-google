<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ICD-10 Online Search Tool</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 700px; margin: auto; }
    input, button, select { padding: 8px; margin: 5px 0; width: 100%; }
    .result { background: #f9f9f9; padding: 10px; border: 1px solid #ccc; margin-top: 10px; border-radius: 5px; }
    a { text-decoration: none; color: #0645ad; }
    .copied-msg { color: green; font-size: 0.9em; margin-top: 5px; display: none; }
    .hint { font-size: 0.9em; color: gray; margin-top: -5px; }
    .history { font-size: 0.9em; margin-top: 10px; }
    .history-item { cursor: pointer; color: blue; text-decoration: underline; }
    .quick-links { margin-top: 15px; display: flex; gap: 10px; flex-direction: column; }
    .quick-links button { width: auto; padding: 6px 10px; font-size: 0.9em; }
  </style>
</head>
<body>
  <h2>ICD-10 Online Search Assistant (Google AI Summary)</h2>

  <label for="diagnosis">Diagnosis (e.g. BCC, SCC, AK, MEL):</label>
  <input type="text" id="diagnosis" placeholder="Enter diagnosis abbreviation or full name" list="diagnosisList" autocomplete="off">
  <datalist id="diagnosisList"></datalist>
  <div class="hint">Common abbreviations will be automatically expanded, even if followed by descriptors or separated by commas. Multiple diagnoses can be separated by semicolons.</div>

  <label for="location">Body Location (e.g. cheek, scalp, arm):</label>
  <input type="text" id="location" placeholder="Enter body site">

  <label for="engine">Search Engine:</label>
  <select id="engine">
    <option value="google">Google</option>
    <option value="bing">Bing</option>
    <option value="duckduckgo">DuckDuckGo</option>
  </select>

  <button onclick="searchAndCopy()">üîç Search & üìã Copy</button>
  <button onclick="copyDiagnosisToClipboard()">üìã Copy Only</button>
  <button onclick="searchICD10Only()">üîç Search Only</button>
  <div class="quick-links">
    <button onclick="openICD10Data()">üîó Search on ICD10Data.com</button>
    <button onclick="openPubMed()">üîó Search on PubMed</button>
  </div>
  <div id="copied" class="copied-msg"></div>

  <div id="result" class="result" style="display:none;"></div>

  <div class="history">
    <strong>Recent Searches:</strong>
    <ul id="historyList"></ul>
  </div>

  <script>
    const diagnosisMap = {
      "BCC": "basal cell carcinoma",
      "SCC": "squamous cell carcinoma",
      "AK": "actinic keratosis",
      "MEL": "melanoma",
      "SK": "seborrheic keratosis",
      "DF": "dermatofibroma",
      "KA": "keratoacanthoma",
      "FEP": "fibroepithelial polyp",
      "CN": "compound nevus",
      "BLK": "benign lichenoid keratosis"
    };

    function capitalizeEachWord(str) {
      return str.replace(/\b\w+/g, word => word.charAt(0).toUpperCase() + word.slice(1));
    }

    function expandDiagnosis(input) {
      return input.split(';').map(part => {
        const subparts = part.split(',');
        const firstWord = subparts[0].trim();
        const firstWordUpper = firstWord.toUpperCase();
        const expanded = diagnosisMap[firstWordUpper] || firstWord;
        const rest = subparts.slice(1).map(s => s.trim()).filter(Boolean);
        return [expanded, ...rest].join(', ');
      }).join('; ');
    }

    function getPrompt(expandedDiag, loc) {
      return `icd 10 code for ${expandedDiag} at skin of ${loc}`;
    }

    function getSearchURL(engine, query) {
      const encoded = encodeURIComponent(query);
      if (engine === 'bing') return `https://www.bing.com/search?q=${encoded}`;
      if (engine === 'duckduckgo') return `https://duckduckgo.com/?q=${encoded}`;
      return `https://www.google.com/search?q=${encoded}`;
    }

    function updateHistory(rawDiag, loc) {
      const history = JSON.parse(localStorage.getItem("icd10_history") || "[]");
      const entry = `${rawDiag} @ ${loc}`;
      if (!history.includes(entry)) {
        history.unshift(entry);
        if (history.length > 5) history.pop();
        localStorage.setItem("icd10_history", JSON.stringify(history));
      }
      renderHistory();
    }

    function renderHistory() {
      const history = JSON.parse(localStorage.getItem("icd10_history") || "[]");
      const list = document.getElementById("historyList");
      list.innerHTML = "";
      history.forEach(item => {
        const li = document.createElement("li");
        li.innerText = item;
        li.className = "history-item";
        li.onclick = () => {
          const [diag, loc] = item.split(" @ ");
          document.getElementById("diagnosis").value = diag;
          document.getElementById("location").value = loc;
        };
        list.appendChild(li);
      });
    }

    function searchAndCopy() {
      const rawDiag = document.getElementById("diagnosis").value.trim();
      const loc = document.getElementById("location").value.trim();
      const engine = document.getElementById("engine").value;
      if (!rawDiag || !loc) {
        alert("Please enter both diagnosis and location.");
        return;
      }
      const expandedDiag = expandDiagnosis(rawDiag);
      const capitalizedDiag = capitalizeEachWord(expandedDiag);
      const prompt = getPrompt(capitalizedDiag, loc);
      const url = getSearchURL(engine, prompt);

      navigator.clipboard.writeText(capitalizedDiag)
        .then(() => {
          const copiedMsg = document.getElementById("copied");
          copiedMsg.innerText = `‚úÖ Copied "${capitalizedDiag}" to clipboard!`;
          copiedMsg.style.display = "block";
          setTimeout(() => copiedMsg.style.display = "none", 2000);
        })
        .catch(err => alert("Copy failed: " + err));

      const newTab = document.createElement("a");
      newTab.href = url;
      newTab.target = "_blank";
      newTab.rel = "noopener noreferrer";
      document.body.appendChild(newTab);
      newTab.click();
      document.body.removeChild(newTab);

      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = `<p>Result opened in a new tab:</p><p><strong>Expanded diagnosis:</strong> ${capitalizedDiag}</p><p><a href="${url}" target="_blank">üîó ${url}</a></p>`;
      resultDiv.style.display = "block";

      updateHistory(rawDiag, loc);
    }

    function copyDiagnosisToClipboard() {
      const rawDiag = document.getElementById("diagnosis").value.trim();
      if (!rawDiag) {
        alert("Please enter a diagnosis before copying.");
        return;
      }
      const expandedDiag = expandDiagnosis(rawDiag);
      const capitalizedDiag = capitalizeEachWord(expandedDiag);
      navigator.clipboard.writeText(capitalizedDiag)
        .then(() => {
          const copiedMsg = document.getElementById("copied");
          copiedMsg.innerText = `‚úÖ Copied "${capitalizedDiag}" to clipboard!`;
          copiedMsg.style.display = "block";
          setTimeout(() => copiedMsg.style.display = "none", 2000);
        })
        .catch(err => alert("Copy failed: " + err));
    }

    function searchICD10Only() {
      const rawDiag = document.getElementById("diagnosis").value.trim();
      const loc = document.getElementById("location").value.trim();
      const engine = document.getElementById("engine").value;
      if (!rawDiag || !loc) {
        alert("Please enter both diagnosis and location.");
        return;
      }
      const expandedDiag = expandDiagnosis(rawDiag);
      const capitalizedDiag = capitalizeEachWord(expandedDiag);
      const prompt = getPrompt(capitalizedDiag, loc);
      const url = getSearchURL(engine, prompt);

      const newTab = document.createElement("a");
      newTab.href = url;
      newTab.target = "_blank";
      newTab.rel = "noopener noreferrer";
      document.body.appendChild(newTab);
      newTab.click();
      document.body.removeChild(newTab);

      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = `<p>Result opened in a new tab:</p><p><strong>Expanded diagnosis:</strong> ${capitalizedDiag}</p><p><a href="${url}" target="_blank">üîó ${url}</a></p>`;
      resultDiv.style.display = "block";

      updateHistory(rawDiag, loc);
    }

    function openICD10Data() {
      const expandedDiag = expandDiagnosis(document.getElementById("diagnosis").value.trim());
      if (expandedDiag) {
        const url = `https://www.icd10data.com/search?s=${encodeURIComponent(expandedDiag)}`;
        const newTab = document.createElement("a");
        newTab.href = url;
        newTab.target = "_blank";
        newTab.rel = "noopener noreferrer";
        document.body.appendChild(newTab);
        newTab.click();
        document.body.removeChild(newTab);
      }
    }

    function openPubMed() {
      const expandedDiag = expandDiagnosis(document.getElementById("diagnosis").value.trim());
      if (expandedDiag) {
        const url = `https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(expandedDiag)}`;
        const newTab = document.createElement("a");
        newTab.href = url;
        newTab.target = "_blank";
        newTab.rel = "noopener noreferrer";
        document.body.appendChild(newTab);
        newTab.click();
        document.body.removeChild(newTab);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      navigator.clipboard.readText()
        .then(text => {
          if (text && text.length < 80) {
            document.getElementById("diagnosis").value = text;
          }
        })
        .catch(() => {});
      renderHistory();

      const list = document.getElementById("diagnosisList");
      Object.entries(diagnosisMap).forEach(([abbr, full]) => {
        new Set([abbr, full]).forEach(val => {
          const opt = document.createElement("option");
          opt.value = val;
          list.appendChild(opt);
        });
      });
    });

    document.addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        searchAndCopy();
      }
    });
  </script>
</body>
</html>
